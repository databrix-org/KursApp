{% extends "course/editcourse/management_base.html" %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'course/css/manage_groups.css' %}">
{% endblock %}

{% block management_content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">Teamverwaltung</h2>
            {% if course.is_published %}
                <div class="d-flex align-items-center">
                    <span class="text-muted me-3">
                        <i class="fas fa-lock me-1"></i>
                        Teams können nach der Kursveröffentlichung nicht mehr erstellt werden
                    </span>
                    <button class="btn btn-secondary create-group-btn action-button" disabled>
                        <i class="fas fa-plus me-2"></i>Neues Team erstellen
                    </button>
                </div>
            {% else %}
                <button class="btn btn-primary create-group-btn action-button" id="createGroupBtn">
                    <i class="fas fa-plus me-2"></i>Neues Team erstellen
                </button>
            {% endif %}
        </div>

        <div class="card management-card">
            <div class="card-body">
                <div id="loadingSpinner" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Lädt...</span>
                    </div>
                </div>
                <div class="table-container">
                    <table class="table table-hover" id="groupsTable">
                        <thead>
                            <tr>
                                <th>Team-Nr.</th>
                                <th>Mitglieder</th>
                                <th>Erstellt am</th>
                                <th>Aktionen</th>
                                <th>Kontakt</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for group in groups %}
                            <tr data-group-id="{{ group.id }}">
                                <td>{{ group.id }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <button class="btn btn-link text-decoration-none members-link p-0" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#membersModal" 
                                                data-group-id="{{ group.id }}">
                                            <span class="member-count">{{ group.member_count }}</span> Mitglieder
                                            <i class="fas fa-users ms-2"></i>
                                        </button>
                                    </div>
                                </td>
                                <td>{{ group.created_at|date:"d.m.Y H:i" }}</td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary view-workspace-btn" 
                                                data-domain="{{ course.domain_name }}"
                                                data-group="group_{{ group.id }}"
                                                data-exercise-name="{{ course.slug|slugify }}">
                                            <i class="fas fa-external-link-alt me-1"></i>Arbeitsbereich öffnen
                                        </button>
                                        {% if course.is_published %}
                                            <button class="btn btn-sm btn-secondary" disabled
                                                    title="Teams können nach der Kursveröffentlichung nicht mehr gelöscht werden">
                                                <i class="fas fa-lock me-1"></i>Löschen
                                            </button>
                                        {% else %}
                                            <button class="btn btn-sm btn-danger delete-group-btn" 
                                                    data-group-id="{{ group.id }}">
                                                <i class="fas fa-trash-alt me-1"></i>Löschen
                                            </button>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary email-group-btn"
                                            data-group-id="{{ group.id }}">
                                        <i class="fas fa-envelope me-1"></i>E-Mail Senden
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Members Modal -->
<div class="modal fade custom-modal" id="membersModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-users"></i>
                    Teammitglieder
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Members List Section -->
                <div class="member-list-container">
                    <div id="membersList" class="list-group">
                        <div class="text-center py-3 d-none" id="membersLoadingSpinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Lade Mitglieder...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Student Section -->
                <div class="add-student-section">
                    <label for="studentSelect" class="form-label">
                        <i class="fas fa-user-plus me-2"></i>Student hinzufügen
                    </label>
                    <div class="input-group">
                        <select class="form-select" id="studentSelect">
                            <option value="">Student auswählen...</option>
                            {% for student in students %}
                            <option value="{{ student.id }}">{{ student.get_full_name }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-primary" type="button" id="addStudentBtn" disabled>
                            <i class="fas fa-plus me-1"></i>Hinzufügen
                        </button>
                    </div>
                    <div class="member-limit-info">
                        <i class="fas fa-info-circle"></i>
                        <span>Maximale Anzahl Teammitglieder: {{ max_members }}</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>


<!-- Toast Notifications -->
<div class="position-fixed bottom-0 end-0 p-3 toast-container">
    <div id="toastNotification" class="toast custom-toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-info-circle me-2"></i>
            <strong class="me-auto" id="toastTitle">Benachrichtigung</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// Set data attributes for JavaScript to access
document.body.dataset.courseId = '{{ course.id }}';
document.body.dataset.courseTitle = '{{ course.title|escapejs }}';
</script>
<script src="{% static 'course/js/manage-groups.js' %}"></script>
{% endblock %} 